<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポータルマスター 使い方ガイド</title>
    <style>
        body {
            font-family: 'Yu Gothic', 'Meiryo', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .nav {
            background: #2c3e50;
            padding: 0;
        }
        .nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
        }
        .nav li {
            flex: 1;
            min-width: 150px;
        }
        .nav a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px;
            text-align: center;
            border-right: 1px solid #34495e;
            transition: background-color 0.3s;
        }
        .nav a:hover {
            background-color: #34495e;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .section h3 {
            color: #34495e;
            margin-top: 25px;
        }
        .menu-item {
            background: white;
            margin: 15px 0;
            padding: 20px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .menu-item h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .menu-item .function-name {
            background: #ecf0f1;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .warning h4 {
            color: #856404;
            margin: 0 0 10px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .info h4 {
            color: #0c5460;
            margin: 0 0 10px 0;
        }
        .step-list {
            counter-reset: step-counter;
        }
        .step {
            counter-increment: step-counter;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
            position: relative;
        }
        .step::before {
            content: counter(step-counter);
            position: absolute;
            left: -15px;
            top: 15px;
            background: #27ae60;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .step-content {
            margin-left: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #667eea;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
        }
        @media (max-width: 768px) {
            .nav ul {
                flex-direction: column;
            }
            .nav li {
                min-width: auto;
            }
            .nav a {
                border-right: none;
                border-bottom: 1px solid #34495e;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 ポータルマスター</h1>
            <p>学校業務支援システム - 最新版使い方ガイド v2.0</p>
        </div>

        <nav class="nav">
            <ul>
                <li><a href="#overview">概要</a></li>
                <li><a href="#initial-setup">導入</a></li>
                <li><a href="#settings">設定</a></li>
                <li><a href="#daily-use">日常業務</a></li>
                <li><a href="#duty">日直</a></li>
                <li><a href="#reporting">集計</a></li>
                <li><a href="#integration-renewal">連携と年度更新</a></li>
                <li><a href="#automation">自動実行</a></li>
                <li><a href="#troubleshooting">トラブル対処</a></li>
                <li><a href="#faq">FAQ</a></li>
            </ul>
        </nav>

        <div class="content">
            <section id="overview" class="section">
                <h2>🎯 システム概要</h2>
                <p>ポータルマスター v2.0は、小学校の年間行事管理を効率化する高性能Google Apps Scriptシステムです。新しい直感的メニューと、改善されたパフォーマンスで、より快適な学校業務を実現します。</p>
                
                <div class="info">
                    <h4>🆕 v2.0の主な改善点</h4>
                    <ul>
                        <li><strong>🎆 新しいメニュー:</strong> 絵文字アイコンで直感的な操作</li>
                        <li><strong>⚡ 性能向上:</strong> バッチ処理で高速化</li>
                        <li><strong>🔗 統一管理:</strong> 共通関数で保守性向上</li>
                        <li><strong>🛡️ エラー処理:</strong> 強化された例外処理</li>
                        <li><strong>🎯 新機能:</strong> ガイド表示、年度更新ファイル作成など</li>
                        <li><strong>ℹ️ 製作者情報:</strong> メニューから製作者情報を確認可能</li>
                    </ul>
                </div>
                
                <h3>主な機能</h3>
                <ul>
                    <li><strong>年間行事管理</strong>：Googleスプレッドシートからの行事予定インポートと管理</li>
                    <li><strong>週報作成</strong>：PDF形式での週報自動生成</li>
                    <li><strong>時数計算</strong>：学年別授業時数の自動集計</li>
                    <li><strong>カレンダー連携</strong>：Googleカレンダーとの自動同期</li>
                    <li><strong>自動化</strong>：定期処理のトリガー設定</li>
                </ul>

                <div class="info">
                    <h4>📋 必要な権限</h4>
                    <p>このシステムは以下のGoogle サービスにアクセスします：</p>
                    <ul>
                        <li>Google スプレッドシート（データ管理）</li>
                        <li>Google ドライブ（ファイル保存）</li>
                        <li>Google カレンダー（行事予定同期）</li>
                    </ul>
                </div>

                <div class="info">
                    <h4>❓ 使い方ガイドへのアクセス</h4>
                    <p>このガイドはメニューバーの<strong>「🎯 ポータルマスター」→「❓ ヘルプ」→「使い方ガイド」</strong>からいつでもアクセスできます。</p>
                    <ul>
                        <li>1クリックで素早くアクセス</li>
                        <li>HTMLファイルが見つからない場合は簡易版ガイドを自動表示</li>
                        <li>システム内で直接ヘルプを参照可能</li>
                    </ul>
                </div>

                <div class="info">
                    <h4>📑 このガイドの構成</h4>
                    <p>このガイドは以下のセクションで構成されています。各セクション名をクリックすると該当箇所へ移動できます：</p>
                    <ol>
                        <li><a href="#initial-setup" style="color: #667eea; text-decoration: none;"><strong>🚀 導入手順</strong></a> - 3ステップの初期導入</li>
                        <li><a href="#settings" style="color: #667eea; text-decoration: none;"><strong>⚙️ 設定</strong></a> - 年度更新設定と自動トリガー設定</li>
                        <li><a href="#daily-use" style="color: #667eea; text-decoration: none;"><strong>📅 日常業務</strong></a> - 週報PDF保存、フォルダ管理、日付移動</li>
                        <li><a href="#duty" style="color: #667eea; text-decoration: none;"><strong>👥 日直</strong></a> - 自動割り当て、日直更新、休業期間集計</li>
                        <li><a href="#reporting" style="color: #667eea; text-decoration: none;"><strong>📊 集計</strong></a> - 累計時数、学年別集計、モジュール学習管理</li>
                        <li><a href="#integration-renewal" style="color: #667eea; text-decoration: none;"><strong>🔁 連携と年度更新</strong></a> - カレンダー同期と年度更新ファイル作成</li>
                        <li><a href="#automation" style="color: #667eea; text-decoration: none;"><strong>⚙️ 自動実行設定</strong></a> - 定期的な自動処理の設定・管理</li>
                        <li><a href="#troubleshooting" style="color: #667eea; text-decoration: none;"><strong>🚨 トラブルシューティング</strong></a> - よくある問題と解決方法</li>
                        <li><a href="#faq" style="color: #667eea; text-decoration: none;"><strong>❓ よくある質問（FAQ）</strong></a> - 日直機能、自動実行など</li>
                    </ol>
                </div>
            </section>

            <section id="initial-setup" class="section">
                <h2>🚀 導入手順</h2>
                <p>システムを使い始める際は、まず以下の3手順を実行してください。</p>

                <div class="info">
                    <h4>🎯 新しいメニューアクセス</h4>
                    <p>スプレッドシートのメニューバーから<strong>「🎯 ポータルマスター」</strong>の各サブメニューを選択してください（手順ごとにメニューが異なります）。</p>
                </div>

                <div class="step-list">
                    <div class="step">
                        <div class="step-content">
                            <h4>ステップ1: 年間行事計画をインポート</h4>
                            <p><span class="function-name">importAnnualEvents</span></p>
                            <p>Googleスプレッドシート「Excel小学校年間行事計画（編集用）」の「メインデータ」シートから行事予定をインポートします。</p>
                            <ul>
                                <li><strong>🎯 ポータルマスター</strong> → <strong>🚀 導入</strong> → <strong>年間行事計画をインポート</strong></li>
                                <li>ダイアログでGoogleスプレッドシートのURLを入力</li>
                                <li>「⚙️ 設定」→「年度更新設定」で基準日（日曜日）を事前設定</li>
                                <li>日付の自動補完と整合性チェック機能付き</li>
                            </ul>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-content">
                            <h4>ステップ2: 日直を自動割り当て</h4>
                            <p><span class="function-name">assignDuty</span></p>
                            <p>日直表の番号順に、マスターシートへ日直を自動割り当てします。</p>
                            <ul>
                                <li><strong>🎯 ポータルマスター</strong> → <strong>👥 日直</strong> → <strong>日直を自動割り当て</strong></li>
                                <li>「日直表」シートの氏名（C列）と日直番号（D列）を使用</li>
                                <li>マスターシートAO列へ日直情報を設定</li>
                                <li>割り当て後、必要に応じて「日直のみ更新」で年間行事予定表へ反映</li>
                            </ul>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-content">
                            <h4>ステップ3: 行事予定表へ反映</h4>
                            <p><span class="function-name">updateAnnualEvents</span></p>
                            <p>マスターシートのデータを「年間行事予定表」シートに高速バッチ処理で反映させます。</p>
                            <ul>
                                <li><strong>🎯 ポータルマスター</strong> → <strong>🚀 導入</strong> → <strong>行事予定表へ反映</strong></li>
                                <li>パフォーマンスが大幅に改善（従来の36倍高速）</li>
                                <li>6x6の校時データを一括バッチ処理</li>
                                <li>処理完了後、マスターシートは自動的に非表示</li>
                                <li>以後は「年間行事予定表」シートを直接編集</li>
                            </ul>
                        </div>
                    </div>

                </div>

                <div class="warning">
                    <h4>⚠️ 導入時の注意点</h4>
                    <ul>
                        <li>手順は必ず1→2→3の順序で実行してください</li>
                        <li>導入後は「⚙️ 設定」で年度更新設定と自動トリガー設定を確認してください</li>
                    </ul>
                </div>
            </section>

            <section id="settings" class="section">
                <h2>⚙️ 設定</h2>

                <div class="info">
                    <h4>📱 メニューアクセス</h4>
                    <p><strong>🎯 ポータルマスター</strong> → <strong>⚙️ 設定</strong> から各機能を選択してください。</p>
                </div>

                <div class="menu-item">
                    <h4>🗂️ 年度更新設定</h4>
                    <p><span class="function-name">showAnnualUpdateSettingsDialog</span></p>
                    <p>年度更新に必要な設定値（C5/C7/C11/C14/C15/C16）をダイアログで一元管理します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> ⚙️ 設定 → 年度更新設定</li>
                        <li>複製ファイル名、複製先フォルダID、基準日（日曜日）を入力</li>
                        <li>週報フォルダID・カレンダーIDを編集または空欄化して自動再作成に対応</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>⚙️ 自動トリガー設定</h4>
                    <p><span class="function-name">showTriggerSettingsDialog</span></p>
                    <p>週報PDF保存・累計時数計算・カレンダー同期・日付リンクの実行タイミングを調整します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> ⚙️ 設定 → 自動トリガー設定</li>
                        <li>機能ごとのON/OFF、曜日、時刻をダイアログで変更可能</li>
                    </ul>
                </div>

                <div class="warning">
                    <h4>⚠️ app_config シートについて</h4>
                    <ul>
                        <li><strong>app_config</strong> は内部管理用のため通常は非表示です</li>
                        <li>設定変更は原則「⚙️ 設定」メニューのダイアログから行ってください</li>
                        <li>直接確認が必要な場合は「表示」→「非表示のシート」から一時表示できます</li>
                    </ul>
                </div>
            </section>

            <section id="daily-use" class="section">
                <h2>📅 日常業務での使用方法</h2>
                
                <div class="info">
                    <h4>📱 新しいメニューアクセス</h4>
                    <p><strong>🎯 ポータルマスター</strong> → <strong>📅 日常業務</strong> から各機能を選択してください。</p>
                </div>

                <div class="menu-item">
                    <h4>🔗 今日の日付へ移動</h4>
                    <p><span class="function-name">setDailyHyperlink</span></p>
                    <p>B1セルに今日の日付へのハイパーリンクを設定し、素早くジャンプできます。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 📅 日常業務 → 今日の日付へ移動</li>
                        <li>自動で今日の日付を検索し、該当行へのリンクを作成</li>
                        <li>日付が見つからない場合はエラーメッセージを表示</li>
                        <li>毎日自動実行されるため、手動実行は不要</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>📄 週報をPDF保存</h4>
                    <p><span class="function-name">saveToPDF</span></p>
                    <p>「週報（時数あり）」と「週報（時数あり）次週」シートを高品質PDF形式で保存します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 📅 日常業務 → 📄 週報をPDF保存</li>
                        <li>行の高さを自動調整（U41セルの内容に基づく）</li>
                        <li>ファイル名は自動生成（B1～D1 + 日付範囲）</li>
                        <li>週報フォルダに保存（同名ファイルは上書き）</li>
                        <li>統一されたフォルダ管理（C14セルで一元管理）</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>📁 週報フォルダを開く</h4>
                    <p><span class="function-name">openWeeklyReportFolder</span></p>
                    <p>PDF保存先の週報フォルダをブラウザで素早く開きます。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 📅 日常業務 → 📁 週報フォルダを開く</li>
                        <li>フォルダが存在しない場合は自動作成</li>
                        <li>フォルダIDは統一管理（C14セル）で整合性を保証</li>
                        <li>共通関数による安定したフォルダ管理</li>
                    </ul>
                </div>
            </section>

            <section id="duty" class="section">
                <h2>👥 日直業務</h2>

                <div class="info">
                    <h4>📱 メニューアクセス</h4>
                    <p><strong>🎯 ポータルマスター</strong> → <strong>👥 日直</strong> から各機能を選択してください。</p>
                </div>

                <div class="menu-item">
                    <h4>🧑‍🏫 日直を自動割り当て</h4>
                    <p><span class="function-name">assignDuty</span></p>
                    <p>日直表の番号順に、マスターシートへ日直を自動割り当てします。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 👥 日直 → 日直を自動割り当て</li>
                        <li>「日直表」シートの氏名（C列）と日直番号（D列）を使用</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>📋 日直のみ更新</h4>
                    <p><span class="function-name">updateAnnualDuty</span></p>
                    <p>マスターシートの日直列のみを年間行事予定表へ反映します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 👥 日直 → 日直のみ更新</li>
                        <li>授業時数や他カテゴリは変更せず、日直情報だけを更新</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>⭐ 休業期間日直を集計</h4>
                    <p><span class="function-name">countStars</span></p>
                    <p>年間行事予定表のR列に入力された☆を日直ごとに集計し、日直表へ反映します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 👥 日直 → 休業期間日直を集計</li>
                    </ul>
                </div>
            </section>

            <section id="reporting" class="section">
                <h2>📊 集計機能</h2>
                
                <div class="info">
                    <h4>📱 新しいメニューアクセス</h4>
                    <p><strong>🎯 ポータルマスター</strong> → <strong>📊 集計</strong> から各機能を選択してください。</p>
                </div>

                <div class="info">
                    <h4>💡 累計時数について</h4>
                    <p>累計時数の計算は初回設定後に「累計時数を計算」で実行します。その後は自動トリガー設定により週次で自動更新されます。</p>
                </div>

                <div class="menu-item">
                    <h4>🔄 累計時数を計算</h4>
                    <p><span class="function-name">calculateCumulativeHours</span></p>
                    <p>自動トリガーの実行を待たず、最新の土曜日までを対象に累計時数をその場で再計算します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 📊 集計 → 累計時数を計算</li>
                        <li>1〜6年の累計時数を更新し、モジュール学習計画の統合結果も反映</li>
                        <li>自動実行が止まっている時の復旧確認にも使用可能</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>📈 学年別授業時数を集計</h4>
                    <p><span class="function-name">aggregateSchoolEventsByGrade</span></p>
                    <p>指定期間の学年別授業時数を低・中・高学年別に詳細集計します。</p>
                    
                    <h5>使用手順：</h5>
                    <ol>
                        <li><strong>メニュー:</strong> 📊 集計 → 学年別授業時数を集計</li>
                        <li>改善されたダイアログで集計期間と標準授業時数を入力</li>
                        <li>「低学年」「中学年」「高学年」シートが自動作成される</li>
                        <li>共通関数による統一されたカテゴリー管理</li>
                    </ol>

                    <h5>出力内容：</h5>
                    <table>
                        <tr>
                            <th>分類</th>
                            <th>対象学年</th>
                            <th>集計項目</th>
                        </tr>
                        <tr>
                            <td>低学年</td>
                            <td>1・2年</td>
                            <td rowspan="3">
                                <strong>自動集計項目:</strong> 授業時数、儀式、文化、保健、遠足、勤労、欠時数、児童会、クラブ、委員会活動、補習<br>
                                <strong>自動統合項目:</strong> MOD（モジュール学習）※累計時数シートM～P列
                            </td>
                        </tr>
                        <tr>
                            <td>中学年</td>
                            <td>3・4年</td>
                        </tr>
                        <tr>
                            <td>高学年</td>
                            <td>5・6年</td>
                        </tr>
                    </table>
                </div>

                <div class="menu-item">
                    <h4>🧩 モジュール学習管理</h4>
                    <p><span class="function-name">showModulePlanningDialog</span></p>
                    <p>モジュール学習の年間計画時数入力・実績調整入力を行い、保存時に自動再計算して累計時数へ反映します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 📊 集計 → モジュール学習管理</li>
                        <li>年間計画時数保存と実績調整追加のどちらでも再計算を実行</li>
                    </ul>
                </div>

                <div class="info">
                    <h4>📈 時数集計のポイント</h4>
                    <ul>
                        <li>「○」マークは授業時数としてカウント</li>
                        <li>行事カテゴリー（儀式、文化等）は短縮形で入力</li>
                        <li>月別での詳細な内訳を確認可能</li>
                        <li>標準授業時数と実施時数の比較が容易</li>
                        <li><strong>🧩 モジュール学習について:</strong> モジュール学習管理ダイアログで年間計画時数と実績調整を入力します。日次配分は保存せず、再計算時に累計へ反映します。実績調整は15分単位で入力します。</li>
                        <li><strong>⚠️ R列について:</strong> 年間行事予定表のR列は日直運用のための列です。モジュール学習集計では使用しません。</li>
                    </ul>
                </div>
            </section>

            <section id="integration-renewal" class="section">
                <h2>🔁 連携と年度更新</h2>

                <div class="info">
                    <h4>📱 メニューアクセス</h4>
                    <p><strong>🎯 ポータルマスター</strong> → <strong>🔁 連携と年度更新</strong> から各機能を選択してください。</p>
                </div>

                <div class="menu-item">
                    <h4>📅 カレンダーと同期</h4>
                    <p><span class="function-name">syncCalendars</span></p>
                    <p>年間行事予定表の内容をGoogleカレンダーに同期します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 🔁 連携と年度更新 → カレンダーと同期</li>
                        <li>「行事予定カレンダー」（D列）と「対外行事カレンダー」（M列）を作成</li>
                        <li>時間指定がある場合は時間付きイベント、なければ終日イベント</li>
                        <li>日本の祝日と重複するイベントは除外</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>📋 年度更新ファイル作成</h4>
                    <p><span class="function-name">copyAndClear</span></p>
                    <p>現在のスプレッドシートをバックアップとしてコピーし、このファイル（現在のURL）を新年度用に初期化します。</p>
                    <ul>
                        <li><strong>メニュー:</strong> 🔁 連携と年度更新 → 年度更新ファイル作成</li>
                        <li>「⚙️ 設定」→「年度更新設定」で保存したC5（ファイル名）とC7（フォルダID）に基づいて実行</li>
                        <li>バックアップ作成後、現在のファイルの「年間行事予定表」D2:S と U2:AB のデータを自動クリア</li>
                        <li>ポータルマスターのURLは変わりません（同じファイルを継続利用）</li>
                    </ul>
                </div>
            </section>

            <section id="automation" class="section">
                <h2>⚙️ 自動実行設定</h2>

                <div class="info">
                    <p>「⚙️ 設定」→「自動トリガー設定」で有効化した処理は、以下の内容で定期実行されます。このセクションでは、自動実行の仕組みと設定方法を説明します。</p>
                </div>

                <h3>自動実行される機能</h3>
                <p>設定したトリガーにより、以下の機能が自動実行されます：</p>

                <table>
                    <tr>
                        <th>機能</th>
                        <th>実行タイミング</th>
                        <th>処理内容</th>
                    </tr>
                    <tr>
                        <td>週報PDF保存</td>
                        <td>週次（曜日・時刻カスタマイズ可能）</td>
                        <td>週報シートを自動的にPDF化して保存<br><small>デフォルト: 毎週月曜日 午前2時</small></td>
                    </tr>
                    <tr>
                        <td>累計時数計算</td>
                        <td>週次（曜日・時刻カスタマイズ可能）</td>
                        <td>直近土曜日までの累計時数を更新<br><small>デフォルト: 毎週月曜日 午前2時</small></td>
                    </tr>
                    <tr>
                        <td>カレンダー同期</td>
                        <td>毎日（時刻カスタマイズ可能）</td>
                        <td>年間行事予定をGoogleカレンダーに同期<br><small>デフォルト: 毎日 午前3時</small></td>
                    </tr>
                    <tr>
                        <td>今日の日付へ移動</td>
                        <td>毎日（時刻カスタマイズ可能）</td>
                        <td>B1セルに今日の日付へのリンクを設定<br><small>デフォルト: 毎日 午前4時</small></td>
                    </tr>
                </table>

                <div class="info">
                    <h4>⚙️ 自動実行のカスタマイズ</h4>
                    <p>「⚙️ 設定」→「自動トリガー設定」から、各処理の実行タイミングを自由にカスタマイズできます。</p>
                    <ul>
                        <li>トグルスイッチで各処理の有効/無効を切り替え</li>
                        <li>週次処理は曜日と時刻を選択</li>
                        <li>毎日処理は時刻を選択</li>
                        <li>設定はダイアログで管理され、内部的に「app_config」シートC18～C28に保存</li>
                    </ul>
                </div>

                <div class="warning">
                    <h4>⚠️ カレンダー管理の注意</h4>
                    <ul>
                        <li>カレンダーIDは「🗂️ 年度更新設定」で管理し、内部的に「app_config」シートC15・C16セルに保存されます</li>
                        <li>初回実行時に新しいカレンダーが自動作成されます</li>
                        <li>削除したカレンダーを復旧する場合はIDをクリアして再実行してください</li>
                    </ul>
                </div>
            </section>

            <section id="troubleshooting" class="section">
                <h2>🚨 トラブルシューティング</h2>

                <h3>よくある問題と解決方法</h3>

                <div class="menu-item">
                    <h4>「シートが見つかりません」エラー</h4>
                    <p><strong>原因：</strong>必要なシートが存在しない、または名前が間違っている</p>
                    <p><strong>解決方法：</strong></p>
                    <ul>
                        <li>以下のシートが存在することを確認：
                            <ul>
                                <li>年間行事予定表</li>
                                <li>app_config</li>
                                <li>マスター</li>
                                <li>累計時数</li>
                                <li>時数様式</li>
                                <li>日直表</li>
                                <li>module_control</li>
                                <li>週報（時数あり）</li>
                                <li>週報（時数あり）次週</li>
                            </ul>
                        </li>
                        <li>app_config, module_control は通常非表示のため、「表示」→「非表示のシート」も確認</li>
                        <li>シート名に余分な空白やタブ文字がないことを確認</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>PDF保存ができない</h4>
                    <p><strong>原因：</strong>週報フォルダの作成権限がない、またはドライブ容量不足</p>
                    <p><strong>解決方法：</strong></p>
                    <ul>
                        <li>Googleドライブの空き容量を確認</li>
                        <li>スプレッドシートが保存されているフォルダの権限を確認</li>
                        <li>「⚙️ 設定」→「年度更新設定」で週報フォルダID（C14）をクリアして再実行</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>カレンダー同期が機能しない</h4>
                    <p><strong>原因：</strong>Googleカレンダーへのアクセス権限がない</p>
                    <p><strong>解決方法：</strong></p>
                    <ul>
                        <li>スクリプトエディタで権限を再承認</li>
                        <li>「⚙️ 設定」→「年度更新設定」でC15・C16をクリアして再実行</li>
                        <li>Googleカレンダーの「マイカレンダー」に新しいカレンダーが作成されることを確認</li>
                    </ul>
                </div>

                <h3>エラーログの確認方法</h3>
                <ol>
                    <li>スプレッドシートで「拡張機能」→「Apps Script」を選択</li>
                    <li>左メニューの「実行数」をクリック</li>
                    <li>実行履歴とエラー内容を確認</li>
                    <li>エラーの詳細を確認して対処</li>
                </ol>

                <div class="info">
                    <h4>💡 問題解決のヒント</h4>
                    <ul>
                        <li>エラーが発生した場合は、まずシート名と必要なデータが正しく入力されているかを確認</li>
                        <li>権限関係のエラーの場合は、スクリプトの再承認を試行</li>
                        <li>データが見つからないエラーの場合は、参照しているセル範囲を確認</li>
                        <li>解決しない場合は製作者に連絡（メニューの「製作者情報」参照）</li>
                    </ul>
                </div>
            </section>

            <section class="section">
                <h2>🔧 v2.0 技術的改善点</h2>
                <p>ポータルマスター v2.0では、システムの根本的な改善を行いました：</p>

                <div class="menu-item">
                    <h4>📁 共通関数システム</h4>
                    <p><span class="function-name">common.js</span></p>
                    <p>新規作成された共通関数ファイルにより、システム全体の整合性と保守性が大幅に向上しました。</p>
                    <ul>
                        <li><strong>日付処理の統一:</strong> `formatDateToJapanese()` で一貫した日付フォーマット</li>
                        <li><strong>名前処理の標準化:</strong> `extractFirstName()` で全角・半角スペース統一処理</li>
                        <li><strong>フォルダ管理の統一:</strong> `getWeeklyReportFolderId()` で一元管理</li>
                        <li><strong>カレンダー管理の統一:</strong> `getOrCreateCalendarId()` で動的ID管理</li>
                        <li><strong>エラー処理の統一:</strong> `showAlert()` で堅牢性向上</li>
                        <li><strong>定数管理:</strong> `EVENT_CATEGORIES`, `CONFIG_CELLS` で一元化</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>⚡ パフォーマンス改善</h4>
                    <ul>
                        <li><strong>バッチ処理導入:</strong> 従来の個別セル操作を一括処理に変更</li>
                        <li><strong>年間行事インポート:</strong> 6x6の校時データを一括設定（36倍高速化）</li>
                        <li><strong>土曜日計算ロジック:</strong> 今日が土曜日の場合の処理を改善</li>
                        <li><strong>不要パラメータ削除:</strong> 使われていない引数を整理</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>🛡️ 整合性・安定性向上</h4>
                    <ul>
                        <li><strong>フォルダID統一:</strong> C14セルで週報フォルダを一元管理</li>
                        <li><strong>名前処理統一:</strong> 正規表現 `/[\s\u3000]+/` で一貫処理</li>
                        <li><strong>カテゴリー統一:</strong> 行事カテゴリーを共通定数で管理</li>
                        <li><strong>エラーハンドリング強化:</strong> UI利用不可時の自動フォールバック</li>
                    </ul>
                </div>

                <h2>📝 設定シート一覧</h2>
                <p>システムが参照する重要な設定値の一覧です（v2.0で統一管理）：</p>

                <table>
                    <tr>
                        <th>シート名</th>
                        <th>セル</th>
                        <th>内容</th>
                        <th>v2.0での変更点</th>
                    </tr>
                    <tr>
                        <td rowspan="6">app_config</td>
                        <td>C5</td>
                        <td>バックアップファイル名</td>
                        <td>変更なし</td>
                    </tr>
                    <tr>
                        <td>C7</td>
                        <td>年度更新用フォルダID</td>
                        <td>年度更新ファイル作成時の保存先</td>
                    </tr>
                    <tr>
                        <td>C11</td>
                        <td>基準日（日曜日）</td>
                        <td>日付補完機能を強化</td>
                    </tr>
                    <tr>
                        <td>C14</td>
                        <td>週報フォルダID</td>
                        <td>週報PDF保存用フォルダを統一管理</td>
                    </tr>
                    <tr>
                        <td>C15</td>
                        <td>行事予定カレンダーID</td>
                        <td>動的取得機能を追加</td>
                    </tr>
                    <tr>
                        <td>C16</td>
                        <td>対外行事カレンダーID</td>
                        <td>動的取得機能を追加</td>
                    </tr>
                </table>

                <div class="info">
                    <h4>💡 v2.0での設定管理改善</h4>
                    <ul>
                        <li><strong>機能別管理:</strong> C7（年度更新用）とC14（週報用）で目的別にフォルダID管理</li>
                        <li><strong>自動復旧:</strong> IDがクリアされても自動で再作成</li>
                        <li><strong>動的管理:</strong> ハードコードされていたIDを動的取得に変更</li>
                        <li><strong>エラー耐性:</strong> 設定ミスがあっても自動で修復</li>
                    </ul>
                </div>

                <div class="warning">
                    <h4>⚠️ 設定値の変更について</h4>
                    <p>v2.0では設定値の管理が改善されましたが、手動変更時は以下に注意してください：</p>
                    <ul>
                        <li><strong>C7:</strong> 年度更新ファイル作成時の保存先フォルダID（手動設定または空白で親フォルダを使用）</li>
                        <li><strong>C14:</strong> 週報PDF保存用フォルダID（空白の場合は自動でフォルダ作成）</li>
                        <li><strong>C15, C16:</strong> カレンダーID（空白の場合は新しいカレンダーを自動作成）</li>
                        <li>基準日（C11）は日曜日の日付を設定してください</li>
                        <li>設定値の不整合は共通関数により自動修復されることがあります</li>
                    </ul>
                </div>
            </section>

            <section id="faq" class="section">
                <h2>❓ よくある質問（FAQ）</h2>

                <div class="menu-item">
                    <h4>Q1: 日直機能はどこにありますか？</h4>
                    <p><strong>A:</strong> 日直機能は利用できます。現在は以下の3機能をメニューから実行できます。</p>
                    <ul>
                        <li><strong>日直を自動割り当て</strong>（日直）</li>
                        <li><strong>休業期間日直を集計</strong>（日直）</li>
                        <li><strong>日直のみ更新</strong>（日直）</li>
                    </ul>
                    <p><strong>補足:</strong> 学校ごとの運用差が大きいため、必要に応じて年間行事予定表のR列（日直列）を直接編集してください。</p>
                </div>

                <div class="menu-item">
                    <h4>Q2: 導入手順は何回実行すればよいですか？</h4>
                    <p><strong>A:</strong> 導入手順は、新しいスプレッドシートを作成した時に<strong>1回だけ</strong>実行してください。</p>
                    <ul>
                        <li>導入の3手順を順番通りに実行</li>
                        <li>導入後に「⚙️ 設定」で自動トリガー設定を行う</li>
                        <li>2回目以降は日常業務の機能を使用</li>
                        <li>年度更新時は「年度更新ファイル作成」を使用</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>Q3: 自動実行を停止したい場合はどうすればよいですか？</h4>
                    <p><strong>A:</strong> 「⚙️ 設定」→「自動トリガー設定」から停止できます。</p>
                    <ul>
                        <li>設定ダイアログでトグルスイッチをOFFにする</li>
                        <li>個別の機能ごとに有効/無効を切り替え可能</li>
                        <li>完全に削除したい場合は、スクリプトエディタの「トリガー」メニューから削除</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>Q4: 累計時数が自動更新されない場合は？</h4>
                    <p><strong>A:</strong> 以下を確認してください：</p>
                    <ul>
                        <li>「⚙️ 設定」→「自動トリガー設定」を実施済みか確認</li>
                        <li>「app_config」シートC21セルが空白でないか確認（空白の場合は無効）</li>
                        <li>設定ダイアログで累計時数計算がONになっているか確認</li>
                        <li>スクリプトエディタの「トリガー」メニューで実行ログを確認</li>
                    </ul>
                </div>

                <div class="menu-item">
                    <h4>Q5: エラーが発生した場合の対処方法は？</h4>
                    <p><strong>A:</strong> <a href="#troubleshooting" style="color: #667eea;">トラブルシューティングセクション</a>を参照してください。それでも解決しない場合：</p>
                    <ul>
                        <li>スクリプトエディタのログを確認（実行ログまたはStackdriverログ）</li>
                        <li>「app_config」シートの設定値を確認</li>
                        <li>製作者（中龍馬）までメールまたは電話でお問い合わせください</li>
                    </ul>
                </div>
            </section>
        </div>

        <div class="footer">
            <p>&copy; 2024 ポータルマスター - 学校業務支援システム</p>
            <p>製作者: 中龍馬（Atari Ryuma） | 連絡先: atarirym@open.ed.jp</p>
        </div>
    </div>

    <script>
        // スムーズスクロール
        document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // セクションのハイライト
        window.addEventListener('scroll', function() {
            const sections = document.querySelectorAll('.section');
            const navLinks = document.querySelectorAll('.nav a');
            
            let current = '';
            sections.forEach(function(section) {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (scrollY >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(function(link) {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });
    </script>

    <style>
        .nav a.active {
            background-color: #667eea;
        }
    </style>
</body>
</html>
