<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: "Yu Gothic", sans-serif;
      margin: 0;
      padding: 18px;
      color: #1f2937;
      background: #eef2f7;
    }
    .container {
      background: #ffffff;
      border: 1px solid #dbe3ee;
      border-radius: 12px;
      padding: 16px;
    }
    h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
    }
    h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
      color: #0f172a;
    }
    .lead {
      margin: 0 0 12px 0;
      color: #475569;
      line-height: 1.6;
      font-size: 13px;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #334155;
    }
    .summary-item strong {
      color: #0f172a;
      text-align: right;
    }
    .section {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      background: #ffffff;
      margin-bottom: 10px;
    }
    .section-note {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #64748b;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .toolbar label {
      font-size: 12px;
      color: #475569;
    }
    input,
    select,
    textarea,
    button {
      font-family: inherit;
    }
    input,
    select,
    textarea {
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      color: #0f172a;
      background: #fff;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #f8fafc;
      color: #475569;
    }
    textarea {
      resize: vertical;
      min-height: 34px;
    }
    .plan-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }
    .plan-table th,
    .plan-table td {
      border: 1px solid #e2e8f0;
      padding: 6px;
      font-size: 11px;
      text-align: center;
      vertical-align: middle;
    }
    .plan-table th {
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
    }
    .plan-table input[type="number"] {
      width: 58px;
      text-align: right;
    }
    .plan-table .note-input {
      width: 120px;
      text-align: left;
    }
    .small-btn {
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #0f172a;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .small-btn:hover {
      background: #f1f5f9;
    }
    .reserve-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      padding: 8px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 6px;
      font-size: 12px;
      color: #166534;
    }
    .reserve-summary .reserve-item {
      white-space: nowrap;
    }
    .delta-quick {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 6px 0;
    }
    .exception-form {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      align-items: end;
      margin-bottom: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .field label {
      font-size: 11px;
      color: #475569;
    }
    .hint {
      margin: 0;
      font-size: 11px;
      color: #64748b;
    }
    .exception-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .exception-list th,
    .exception-list td {
      border: 1px solid #e2e8f0;
      padding: 6px;
      font-size: 11px;
      text-align: left;
    }
    .exception-list th {
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
    }
    .action-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    button {
      border: none;
      border-radius: 6px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .primary {
      background: #2563eb;
      color: #fff;
    }
    .sub {
      background: #e2e8f0;
      color: #0f172a;
    }
    .close {
      background: #f1f5f9;
      color: #0f172a;
      min-width: 110px;
    }
    .status {
      margin-top: 10px;
      min-height: 18px;
      color: #475569;
      font-size: 12px;
      white-space: pre-line;
    }
    button:disabled,
    .small-btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
    @media (max-width: 980px) {
      .summary {
        grid-template-columns: 1fr;
      }
      .exception-form {
        grid-template-columns: 1fr 1fr;
      }
      .plan-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>モジュール学習管理</h2>
    <p class="lead">
      内部シートを直接編集せず、この画面で「年間目標」と「実施差分」を管理できます。<br>
      保存時に再集計まで自動実行し、累計時数シートへ反映します。
    </p>

    <div class="summary">
      <div class="summary-item">
        <span>対象年度</span>
        <strong id="fiscalYear">-</strong>
      </div>
      <div class="summary-item">
        <span>年度範囲</span>
        <strong id="fiscalRange">-</strong>
      </div>
      <div class="summary-item">
        <span>日次計画件数（再集計結果）</span>
        <strong id="dailyPlanCount">0件</strong>
      </div>
      <div class="summary-item">
        <span>実施差分件数</span>
        <strong id="exceptionCount">0件</strong>
      </div>
      <div class="summary-item">
        <span>最終更新</span>
        <strong id="lastGeneratedAt">未生成</strong>
      </div>
    </div>

    <section class="section">
      <h3>1. 実施設定</h3>
      <p class="section-note">モジュール学習の実施曜日と実施期間を設定します。</p>

      <div class="toolbar" style="margin-bottom: 12px;">
        <label>実施曜日</label>
        <label style="font-size:13px; margin-left:8px;">
          <input type="checkbox" class="weekday-cb" value="1"> 月
        </label>
        <label style="font-size:13px;">
          <input type="checkbox" class="weekday-cb" value="2"> 火
        </label>
        <label style="font-size:13px;">
          <input type="checkbox" class="weekday-cb" value="3"> 水
        </label>
        <label style="font-size:13px;">
          <input type="checkbox" class="weekday-cb" value="4"> 木
        </label>
        <label style="font-size:13px;">
          <input type="checkbox" class="weekday-cb" value="5"> 金
        </label>
      </div>

      <div class="toolbar">
        <label for="planStartDate">実施期間</label>
        <input id="planStartDate" type="date" style="width:150px;">
        <span style="font-size:13px; color:#475569;">～</span>
        <input id="planEndDate" type="date" style="width:150px;">
      </div>

      <div class="action-row">
        <button type="button" class="primary" id="saveSettingsButton" onclick="saveSettings()">実施設定を保存して再集計</button>
      </div>
    </section>

    <section class="section">
      <h3>2. 年間目標入力</h3>
      <p class="section-note">各学年の年間目標コマ数（1コマ＝45分）を入力してください。</p>
      <div class="toolbar">
        <label for="fiscalYearInput">対象年度</label>
        <input id="fiscalYearInput" type="number" readonly>
        <label for="bulkKomaInput">全学年一括</label>
        <input id="bulkKomaInput" type="number" min="0" step="1" value="28" style="width:68px">
        <button type="button" class="small-btn" onclick="setAllGradeKoma()">一括設定</button>
      </div>
      <table class="plan-table" aria-label="年間目標">
        <thead>
          <tr>
            <th>1年</th>
            <th>2年</th>
            <th>3年</th>
            <th>4年</th>
            <th>5年</th>
            <th>6年</th>
            <th>メモ</th>
          </tr>
        </thead>
        <tbody id="planBody"></tbody>
      </table>
      <div id="reserveSummary" class="reserve-summary" style="display:none;"></div>
      <div class="action-row">
        <button type="button" class="primary" id="savePlanButton" onclick="savePlan()">年間目標を保存して再集計</button>
      </div>
    </section>

    <section class="section">
      <h3>3. 実施差分入力</h3>
      <p class="section-note">実施に合わせて差分だけ入力します。差分値は15分単位で、+は追加・-は減算です（+3は+1コマ、-1は-15分）。</p>

      <div class="exception-form">
        <div class="field">
          <label for="exceptionDate">日付</label>
          <input id="exceptionDate" type="date">
        </div>
        <div class="field">
          <label for="exceptionGrade">学年</label>
          <select id="exceptionGrade"></select>
        </div>
        <div class="field">
          <label for="deltaSessionsInput">差分値（15分=1、1コマ=3）</label>
          <input id="deltaSessionsInput" type="number" step="1" value="3" oninput="updateDeltaHint()">
        </div>
        <div class="field">
          <label for="exceptionReason">理由（任意）</label>
          <input id="exceptionReason" type="text" placeholder="行事変更など">
        </div>
        <div class="field">
          <label for="exceptionNote">メモ（任意）</label>
          <input id="exceptionNote" type="text" placeholder="補足">
        </div>
      </div>

      <div class="delta-quick">
        <button type="button" class="small-btn" onclick="setDelta(3)">+1コマ</button>
        <button type="button" class="small-btn" onclick="setDelta(1)">+15分</button>
        <button type="button" class="small-btn" onclick="setDelta(-1)">-15分</button>
        <button type="button" class="small-btn" onclick="setDelta(-3)">-1コマ</button>
        <span class="hint" id="deltaHint"></span>
      </div>

      <div class="action-row">
        <button type="button" class="primary" id="addExceptionButton" onclick="addException()">実施差分を保存して再集計</button>
      </div>

      <table class="exception-list" aria-label="最近の差分">
        <thead>
          <tr>
            <th>日付</th>
            <th>学年</th>
            <th>差分値</th>
            <th>理由</th>
            <th>メモ</th>
          </tr>
        </thead>
        <tbody id="recentExceptionBody"></tbody>
      </table>
    </section>

    <div class="action-row">
      <button type="button" class="sub" id="refreshButton" onclick="refreshPlanning()">再集計のみ実行</button>
      <button type="button" class="close" id="closeButton" onclick="google.script.host.close()">閉じる</button>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script>
    let currentState = {};

    function setStatus(text) {
      document.getElementById('status').textContent = text || '';
    }

    function setLoading(isLoading) {
      const ids = ['saveSettingsButton', 'savePlanButton', 'addExceptionButton', 'refreshButton', 'closeButton'];
      ids.forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
          el.disabled = isLoading;
        }
      });
    }

    function getErrorMessage(error) {
      if (!error) return '不明なエラー';
      return error.message || error.toString();
    }

    function updateSummary(state) {
      const range = (state.fiscalYearStartDate || '-') + ' ～ ' + (state.fiscalYearEndDate || '-');
      document.getElementById('fiscalYear').textContent = (state.fiscalYear || '-') + '年度';
      document.getElementById('fiscalRange').textContent = range;
      document.getElementById('dailyPlanCount').textContent = (state.dailyPlanRecordCount || 0) + '件';
      document.getElementById('exceptionCount').textContent = (state.exceptionRecordCount || 0) + '件';
      document.getElementById('lastGeneratedAt').textContent = state.lastGeneratedAt || '未生成';
      document.getElementById('fiscalYearInput').value = state.fiscalYear || '';
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderAnnualTarget(target) {
      const tbody = document.getElementById('planBody');
      tbody.innerHTML = '';
      const t = target || {};
      const tr = document.createElement('tr');
      tr.innerHTML = [
        '<td><input type="number" class="grade-koma" data-grade="1" min="0" step="1" value="' + escapeHtml(t.g1Koma || 28) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="2" min="0" step="1" value="' + escapeHtml(t.g2Koma || 28) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="3" min="0" step="1" value="' + escapeHtml(t.g3Koma || 28) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="4" min="0" step="1" value="' + escapeHtml(t.g4Koma || 28) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="5" min="0" step="1" value="' + escapeHtml(t.g5Koma || 28) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="6" min="0" step="1" value="' + escapeHtml(t.g6Koma || 28) + '"></td>',
        '<td><input type="text" class="note-input" value="' + escapeHtml(t.note || '') + '"></td>'
      ].join('');
      tbody.appendChild(tr);
    }

    function setAllGradeKoma() {
      const value = Number(document.getElementById('bulkKomaInput').value);
      if (!Number.isFinite(value) || value < 0) {
        setStatus('全学年一括の値を0以上の数値で入力してください。');
        return;
      }
      const inputs = document.querySelectorAll('#planBody .grade-koma');
      inputs.forEach(function(input) {
        input.value = String(Math.round(value));
      });
    }

    function collectAnnualTarget() {
      const tr = document.querySelector('#planBody tr');
      if (!tr) {
        throw new Error('年間目標の入力行がありません。');
      }

      const target = {
        g1Koma: Number(tr.querySelector('.grade-koma[data-grade="1"]').value),
        g2Koma: Number(tr.querySelector('.grade-koma[data-grade="2"]').value),
        g3Koma: Number(tr.querySelector('.grade-koma[data-grade="3"]').value),
        g4Koma: Number(tr.querySelector('.grade-koma[data-grade="4"]').value),
        g5Koma: Number(tr.querySelector('.grade-koma[data-grade="5"]').value),
        g6Koma: Number(tr.querySelector('.grade-koma[data-grade="6"]').value),
        note: tr.querySelector('.note-input').value || ''
      };

      for (let grade = 1; grade <= 6; grade++) {
        const key = 'g' + grade + 'Koma';
        if (!Number.isFinite(target[key]) || target[key] < 0) {
          throw new Error(grade + '年のコマ数を0以上の数値で入力してください。');
        }
      }

      return target;
    }

    function formatMixedFractionFromSessions(sessions) {
      const rounded = Math.round(Number(sessions) || 0);
      if (rounded === 0) {
        return '0';
      }
      const sign = rounded < 0 ? '-' : '';
      const absValue = Math.abs(rounded);
      const whole = Math.floor(absValue / 3);
      const remainder = absValue % 3;
      if (remainder === 0) {
        return sign + String(whole);
      }
      if (whole === 0) {
        return sign + String(remainder) + '/3';
      }
      return sign + String(whole) + ' ' + String(remainder) + '/3';
    }

    function renderReserveSummary(reserveByGrade) {
      const container = document.getElementById('reserveSummary');
      if (!reserveByGrade) {
        container.style.display = 'none';
        return;
      }

      const items = [];
      for (let grade = 1; grade <= 6; grade++) {
        const sessions = Number(reserveByGrade[grade]) || 0;
        const display = formatMixedFractionFromSessions(sessions);
        items.push('<span class="reserve-item">' + grade + '年: 予備 ' + escapeHtml(display) + 'コマ</span>');
      }

      container.innerHTML = items.join('');
      container.style.display = 'flex';
    }

    function renderRecentExceptions(rows) {
      const tbody = document.getElementById('recentExceptionBody');
      tbody.innerHTML = '';

      if (!Array.isArray(rows) || rows.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="5">実施差分はまだありません。</td>';
        tbody.appendChild(emptyRow);
        return;
      }

      rows.forEach(function(row) {
        const tr = document.createElement('tr');
        tr.innerHTML = [
          '<td>' + escapeHtml(row.date) + '</td>',
          '<td>' + escapeHtml(row.grade) + '年</td>',
          '<td>' + escapeHtml(row.deltaDisplay) + '</td>',
          '<td>' + escapeHtml(row.reason || '') + '</td>',
          '<td>' + escapeHtml(row.note || '') + '</td>'
        ].join('');
        tbody.appendChild(tr);
      });
    }

    function renderWeekdayCheckboxes(enabledWeekdays) {
      const enabled = enabledWeekdays || [1, 3, 5];
      const checkboxes = document.querySelectorAll('.weekday-cb');
      checkboxes.forEach(function(cb) {
        const day = parseInt(cb.value, 10);
        cb.checked = enabled.indexOf(day) !== -1;
      });
    }

    function renderPeriodInputs(state) {
      document.getElementById('planStartDate').value = state.startDate || state.fiscalYearStartDate || '';
      document.getElementById('planEndDate').value = state.endDate || state.fiscalYearEndDate || '';
    }

    function collectWeekdays() {
      const checkboxes = document.querySelectorAll('.weekday-cb:checked');
      const result = [];
      checkboxes.forEach(function(cb) {
        result.push(parseInt(cb.value, 10));
      });
      return result;
    }

    function saveSettings() {
      const weekdays = collectWeekdays();
      if (weekdays.length === 0) {
        setStatus('実施曜日を1つ以上選択してください。');
        return;
      }

      const startDate = document.getElementById('planStartDate').value;
      const endDate = document.getElementById('planEndDate').value;
      if (!startDate || !endDate) {
        setStatus('実施期間の開始日と終了日を入力してください。');
        return;
      }

      setLoading(true);
      setStatus('実施設定を保存して再集計しています...');

      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '実施設定を保存しました。');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('実施設定の保存に失敗しました: ' + getErrorMessage(error));
        })
        .saveModuleSettingsFromDialog({
          weekdays: weekdays,
          startDate: startDate,
          endDate: endDate,
          baseDate: currentState.baseDate
        });
    }

    function applyState(state) {
      currentState = state || {};
      updateSummary(currentState);
      renderWeekdayCheckboxes(currentState.enabledWeekdays || [1, 3, 5]);
      renderPeriodInputs(currentState);
      renderAnnualTarget(currentState.annualTarget || {});
      renderReserveSummary(currentState.reserveByGrade || null);
      renderRecentExceptions(currentState.recentExceptions || []);

      document.getElementById('exceptionDate').value = currentState.defaultExceptionDate || '';
      populateGradeOptions();
      updateDeltaHint();
    }

    function loadDialogState(keepStatus) {
      if (!keepStatus) {
        setStatus('現在の状態を読み込み中...');
      }

      google.script.run
        .withSuccessHandler(function(state) {
          applyState(state || {});
          if (!keepStatus) {
            setStatus('');
          }
        })
        .withFailureHandler(function(error) {
          setStatus('状態の取得に失敗しました: ' + getErrorMessage(error));
        })
        .getModulePlanningDialogState();
    }

    function populateGradeOptions() {
      const select = document.getElementById('exceptionGrade');
      if (select.options.length > 0) {
        return;
      }
      for (let grade = 1; grade <= 6; grade++) {
        const option = document.createElement('option');
        option.value = String(grade);
        option.textContent = grade + '年';
        select.appendChild(option);
      }
    }

    function savePlan() {
      const fiscalYear = Number(document.getElementById('fiscalYearInput').value);
      let target;

      try {
        target = collectAnnualTarget();
      } catch (error) {
        setStatus(getErrorMessage(error));
        return;
      }

      setLoading(true);
      setStatus('年間目標を保存して再集計しています...');

      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '年間目標を保存しました。');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('年間目標の保存に失敗しました: ' + getErrorMessage(error));
        })
        .saveModuleAnnualTargetFromDialog({
          fiscalYear: fiscalYear,
          baseDate: currentState.baseDate,
          target: target
        });
    }

    function setDelta(value) {
      document.getElementById('deltaSessionsInput').value = String(value);
      updateDeltaHint();
    }

    function updateDeltaHint() {
      const sessions = Math.round(Number(document.getElementById('deltaSessionsInput').value) || 0);
      const prefix = sessions > 0 ? '+' : '';
      const minutes = sessions * 15;
      const minutePrefix = minutes > 0 ? '+' : '';
      document.getElementById('deltaHint').textContent = '現在の差分: ' + prefix + formatMixedFractionFromSessions(sessions) + 'コマ（' + minutePrefix + String(minutes) + '分）';
    }

    function addException() {
      const payload = {
        date: document.getElementById('exceptionDate').value,
        grade: Number(document.getElementById('exceptionGrade').value),
        deltaSessions: Number(document.getElementById('deltaSessionsInput').value),
        reason: document.getElementById('exceptionReason').value,
        note: document.getElementById('exceptionNote').value,
        baseDate: currentState.baseDate
      };

      if (!payload.date) {
        setStatus('日付を入力してください。');
        return;
      }
      if (!payload.deltaSessions) {
        setStatus('差分値は0以外で入力してください。');
        return;
      }

      setLoading(true);
      setStatus('実施差分を保存して再集計しています...');

      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '実施差分を追加しました。');
          document.getElementById('exceptionReason').value = '';
          document.getElementById('exceptionNote').value = '';
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('実施差分の保存に失敗しました: ' + getErrorMessage(error));
        })
        .addModuleExceptionFromDialog(payload);
    }

    function refreshPlanning() {
      setLoading(true);
      setStatus('再集計を実行中...');
      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '再集計が完了しました。');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('再集計に失敗しました: ' + getErrorMessage(error));
        })
        .refreshModulePlanning();
    }

    window.onload = function() {
      loadDialogState(false);
      setDelta(3);
    };
  </script>
</body>
</html>
