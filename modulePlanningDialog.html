<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include_('dialogStyles') ?>
  <style>
    /* モジュール学習管理ダイアログ固有スタイル（共通CSSを上書き） */
    body {
      padding: 18px;
    }
    .container {
      max-width: none;
      padding: 16px;
    }
    h2 {
      text-align: left;
      font-size: 20px;
      margin: 0 0 8px 0;
    }
    h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
    }
    .lead {
      margin: 0 0 12px 0;
      color: var(--pm-text-secondary);
      line-height: 1.6;
      font-size: 13px;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      background: #f8fafc;
      border: 1px solid var(--pm-border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #334155;
    }
    .summary-item strong {
      color: var(--pm-text);
      text-align: right;
    }
    .section {
      border: 1px solid var(--pm-border);
      border-radius: 8px;
      padding: 12px;
      background: var(--pm-surface);
      margin-bottom: 10px;
    }
    .section h3 {
      margin: 0 0 10px 0;
    }
    .section-note {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: var(--pm-text-secondary);
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .toolbar label {
      font-size: 12px;
      color: var(--pm-text-secondary);
      font-weight: normal;
    }
    /* コンパクトなinput */
    input,
    select,
    textarea {
      font-size: 12px;
      padding: 6px 8px;
    }
    input[readonly] {
      background: #f8fafc;
      color: var(--pm-text-secondary);
    }
    textarea {
      resize: vertical;
      min-height: 34px;
    }
    /* コンパクトなボタン */
    .btn {
      padding: 9px 12px;
      font-size: 13px;
      margin: 0;
    }
    .small-btn {
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: var(--pm-text);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .small-btn:hover {
      background: #f1f5f9;
    }
    .small-btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
    .small-btn.danger {
      color: var(--pm-error);
      border-color: var(--pm-error);
    }
    .small-btn.danger:hover {
      background: #fef2f2;
    }
    /* クール計画テーブル */
    .plan-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }
    .plan-table th,
    .plan-table td {
      border: 1px solid var(--pm-border);
      padding: 6px;
      font-size: 11px;
      text-align: center;
      vertical-align: middle;
    }
    .plan-table th {
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
    }
    .plan-table input[type="number"] {
      width: 52px;
      text-align: right;
    }
    .plan-table select {
      width: 68px;
    }
    .plan-table .note-input {
      width: 100px;
      text-align: left;
    }
    .plan-table .bulk-input {
      width: 52px;
      text-align: right;
    }
    /* 実施差分フォーム */
    .exception-form {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      align-items: end;
      margin-bottom: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .field label {
      font-size: 11px;
      color: var(--pm-text-secondary);
      font-weight: normal;
    }
    .delta-quick {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 6px 0;
    }
    /* 実施差分テーブル */
    .exception-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .exception-list th,
    .exception-list td {
      border: 1px solid var(--pm-border);
      padding: 6px;
      font-size: 11px;
      text-align: left;
    }
    .exception-list th {
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
    }
    /* 曜日設定 */
    details.section > summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    details.section > summary::-webkit-details-marker {
      display: none;
    }
    details.section > summary::before {
      content: '▶';
      font-size: 10px;
      transition: transform 0.2s;
    }
    details.section[open] > summary::before {
      transform: rotate(90deg);
    }
    details.section > summary h3 {
      display: inline;
      margin: 0;
    }
    .weekday-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
    }
    .weekday-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border: 1px solid var(--pm-border);
      border-radius: 4px;
      margin-bottom: 4px;
      background: var(--pm-surface);
      font-size: 12px;
    }
    .weekday-item.excluded {
      opacity: 0.4;
      background: #f5f5f5;
    }
    .weekday-order {
      font-weight: bold;
      min-width: 18px;
      color: var(--pm-primary);
    }
    .weekday-name {
      flex: 1;
    }
    .weekday-arrows {
      display: flex;
      gap: 2px;
    }
    .weekday-arrows button {
      padding: 2px 6px;
      font-size: 10px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      border-radius: 3px;
      cursor: pointer;
      line-height: 1;
    }
    .weekday-arrows button:hover {
      background: var(--pm-border);
    }
    .weekday-arrows button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    /* プレビュー */
    .preview-area {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 6px;
      padding: 10px;
      margin-top: 8px;
      font-size: 12px;
      display: none;
    }
    .preview-area.visible {
      display: block;
    }
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .preview-table th,
    .preview-table td {
      border: 1px solid #bae6fd;
      padding: 4px 6px;
      font-size: 11px;
      text-align: center;
    }
    .preview-table th {
      background: #e0f2fe;
    }
    /* アクション行 */
    .action-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .status {
      margin-top: 10px;
      min-height: 18px;
      color: var(--pm-text-secondary);
      font-size: 12px;
      white-space: pre-line;
    }
    @media (max-width: 980px) {
      .summary {
        grid-template-columns: 1fr;
      }
      .exception-form {
        grid-template-columns: 1fr 1fr;
      }
      .plan-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>モジュール学習管理</h2>
    <p class="lead">
      内部シートを直接編集せず、この画面で「クール計画」と「実施差分」を管理できます。<br>
      保存時に再集計まで自動実行し、累計時数シートへ反映します。
    </p>

    <div class="summary">
      <div class="summary-item">
        <span>対象年度</span>
        <strong id="fiscalYear">-</strong>
      </div>
      <div class="summary-item">
        <span>年度範囲</span>
        <strong id="fiscalRange">-</strong>
      </div>
      <div class="summary-item">
        <span>クール計画件数</span>
        <strong id="cyclePlanCount">0件</strong>
      </div>
      <div class="summary-item">
        <span>日次計画件数（再集計結果）</span>
        <strong id="dailyPlanCount">0件</strong>
      </div>
      <div class="summary-item">
        <span>実施差分件数</span>
        <strong id="exceptionCount">0件</strong>
      </div>
      <div class="summary-item">
        <span>最終更新</span>
        <strong id="lastGeneratedAt">未生成</strong>
      </div>
    </div>

    <!-- 1. クール計画入力 -->
    <section class="section">
      <h3>1. クール計画入力</h3>
      <p class="section-note">1行が1クールです。コマ数は1コマ（45分）単位で入力してください。「一括」欄に入力すると全学年に反映します。</p>
      <div class="toolbar">
        <label for="fiscalYearInput">対象年度</label>
        <input id="fiscalYearInput" type="number" readonly>
        <button type="button" class="small-btn" id="addPlanRowButton" onclick="addPlanRow()">行を追加</button>
      </div>
      <table class="plan-table" aria-label="クール計画">
        <thead>
          <tr>
            <th>順</th>
            <th>開始月</th>
            <th>終了月</th>
            <th>一括</th>
            <th>1年</th>
            <th>2年</th>
            <th>3年</th>
            <th>4年</th>
            <th>5年</th>
            <th>6年</th>
            <th>メモ</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="planBody"></tbody>
      </table>
      <div class="action-row">
        <button type="button" class="btn btn-primary" id="savePlanButton" onclick="savePlan()">計画を保存して再集計</button>
        <button type="button" class="small-btn" id="previewButton" onclick="previewPlan()">プレビュー</button>
      </div>
      <div class="preview-area" id="previewArea"></div>
    </section>

    <!-- 配分曜日設定 -->
    <details class="section">
      <summary><h3>配分曜日設定</h3></summary>
      <p class="section-note" style="margin-top:8px">
        モジュール学習を配分する曜日と優先順位を設定します。上にあるほど優先的に配分されます。<br>
        チェックを外すとその曜日には配分されません。
      </p>
      <ul class="weekday-list" id="weekdayList"></ul>
      <div class="action-row" style="margin-top:6px">
        <button type="button" class="small-btn" onclick="resetWeekdayOrder()">デフォルトに戻す</button>
        <button type="button" class="btn btn-primary" style="font-size:12px;padding:6px 12px" id="saveWeekdayButton" onclick="saveWeekdayPriority()">曜日設定を保存して再集計</button>
      </div>
    </details>

    <!-- 2. 実施差分入力 -->
    <section class="section">
      <h3>2. 実施差分入力</h3>
      <p class="section-note">実施に合わせて差分だけ入力します。差分値は15分単位で、+は追加・-は減算です（+3は+1コマ、-1は-15分）。</p>

      <div class="exception-form">
        <div class="field">
          <label for="exceptionDate">日付</label>
          <input id="exceptionDate" type="date">
        </div>
        <div class="field">
          <label for="exceptionGrade">学年</label>
          <select id="exceptionGrade"></select>
        </div>
        <div class="field">
          <label for="deltaSessionsInput">差分値（15分=1、1コマ=3）</label>
          <input id="deltaSessionsInput" type="number" step="1" value="3" oninput="updateDeltaHint()">
        </div>
        <div class="field">
          <label for="exceptionReason">理由（任意）</label>
          <input id="exceptionReason" type="text" placeholder="行事変更など">
        </div>
        <div class="field">
          <label for="exceptionNote">メモ（任意）</label>
          <input id="exceptionNote" type="text" placeholder="補足">
        </div>
      </div>

      <div class="delta-quick">
        <button type="button" class="small-btn" onclick="setDelta(3)">+1コマ</button>
        <button type="button" class="small-btn" onclick="setDelta(1)">+15分</button>
        <button type="button" class="small-btn" onclick="setDelta(-1)">-15分</button>
        <button type="button" class="small-btn" onclick="setDelta(-3)">-1コマ</button>
        <span class="hint" id="deltaHint" style="font-size:11px;color:var(--pm-text-secondary)"></span>
      </div>

      <div class="action-row">
        <button type="button" class="btn btn-primary" id="addExceptionButton" onclick="addException()">実施差分を保存して再集計</button>
      </div>

      <table class="exception-list" aria-label="最近の差分">
        <thead>
          <tr>
            <th>日付</th>
            <th>学年</th>
            <th>差分値</th>
            <th>理由</th>
            <th>メモ</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="recentExceptionBody"></tbody>
      </table>
    </section>

    <div class="action-row">
      <button type="button" class="btn btn-secondary" id="refreshButton" onclick="refreshPlanning()">再集計のみ実行</button>
      <button type="button" class="btn btn-secondary" id="closeButton" onclick="google.script.host.close()">閉じる</button>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script>
    let currentState = {};
    const WEEKDAY_NAMES = { 1: '月曜日', 2: '火曜日', 3: '水曜日', 4: '木曜日', 5: '金曜日' };
    const DEFAULT_WEEKDAY_ORDER = [1, 3, 5];
    let currentWeekdayOrder = DEFAULT_WEEKDAY_ORDER.slice();

    const DEFAULT_PLAN_ROWS = [
      { cycleOrder: 1, startMonth: 6, endMonth: 7, g1Koma: 7, g2Koma: 7, g3Koma: 7, g4Koma: 7, g5Koma: 7, g6Koma: 7, note: '' },
      { cycleOrder: 2, startMonth: 9, endMonth: 10, g1Koma: 7, g2Koma: 7, g3Koma: 7, g4Koma: 7, g5Koma: 7, g6Koma: 7, note: '' },
      { cycleOrder: 3, startMonth: 11, endMonth: 12, g1Koma: 7, g2Koma: 7, g3Koma: 7, g4Koma: 7, g5Koma: 7, g6Koma: 7, note: '' },
      { cycleOrder: 4, startMonth: 1, endMonth: 2, g1Koma: 7, g2Koma: 7, g3Koma: 7, g4Koma: 7, g5Koma: 7, g6Koma: 7, note: '' }
    ];

    // ========================================
    // 共通ユーティリティ
    // ========================================

    function setStatus(text) {
      document.getElementById('status').textContent = text || '';
    }

    function setLoading(isLoading) {
      const ids = ['addPlanRowButton', 'savePlanButton', 'previewButton', 'addExceptionButton', 'saveWeekdayButton', 'refreshButton', 'closeButton'];
      ids.forEach(function(id) {
        const el = document.getElementById(id);
        if (el) {
          el.disabled = isLoading;
        }
      });
    }

    function getErrorMessage(error) {
      if (!error) return '不明なエラー';
      return error.message || error.toString();
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // ========================================
    // サマリー
    // ========================================

    function updateSummary(state) {
      const range = (state.fiscalYearStartDate || '-') + ' ～ ' + (state.fiscalYearEndDate || '-');
      document.getElementById('fiscalYear').textContent = (state.fiscalYear || '-') + '年度';
      document.getElementById('fiscalRange').textContent = range;
      document.getElementById('cyclePlanCount').textContent = (state.cyclePlanRecordCount || 0) + '件';
      document.getElementById('dailyPlanCount').textContent = (state.dailyPlanRecordCount || 0) + '件';
      document.getElementById('exceptionCount').textContent = (state.exceptionRecordCount || 0) + '件';
      document.getElementById('lastGeneratedAt').textContent = state.lastGeneratedAt || '未生成';
      document.getElementById('fiscalYearInput').value = state.fiscalYear || '';
    }

    // ========================================
    // クール計画テーブル
    // ========================================

    function buildMonthOptions(selectedMonth) {
      let html = '';
      for (let month = 1; month <= 12; month++) {
        const selected = Number(selectedMonth) === month ? ' selected' : '';
        html += '<option value="' + month + '"' + selected + '>' + month + '月</option>';
      }
      return html;
    }

    function normalizePlanRows(rows) {
      if (!Array.isArray(rows) || rows.length === 0) {
        return DEFAULT_PLAN_ROWS.map(function(item) {
          return Object.assign({}, item);
        });
      }
      return rows.slice().sort(function(a, b) {
        return Number(a.cycleOrder || 0) - Number(b.cycleOrder || 0);
      });
    }

    function appendPlanRow(row) {
      const tbody = document.getElementById('planBody');
      const tr = document.createElement('tr');
      tr.innerHTML = [
        '<td><input type="number" class="cycle-order" min="1" step="1" value="' + escapeHtml(row.cycleOrder) + '"></td>',
        '<td><select class="start-month">' + buildMonthOptions(row.startMonth) + '</select></td>',
        '<td><select class="end-month">' + buildMonthOptions(row.endMonth) + '</select></td>',
        '<td><input type="number" class="bulk-input" min="0" step="1" placeholder="-" onchange="applyBulkKoma(this)"></td>',
        '<td><input type="number" class="grade-koma" data-grade="1" min="0" step="1" value="' + escapeHtml(row.g1Koma) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="2" min="0" step="1" value="' + escapeHtml(row.g2Koma) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="3" min="0" step="1" value="' + escapeHtml(row.g3Koma) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="4" min="0" step="1" value="' + escapeHtml(row.g4Koma) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="5" min="0" step="1" value="' + escapeHtml(row.g5Koma) + '"></td>',
        '<td><input type="number" class="grade-koma" data-grade="6" min="0" step="1" value="' + escapeHtml(row.g6Koma) + '"></td>',
        '<td><input type="text" class="note-input" value="' + escapeHtml(row.note) + '"></td>',
        '<td><button type="button" class="small-btn danger" onclick="removePlanRow(this)" title="行を削除">&times;</button></td>'
      ].join('');
      tbody.appendChild(tr);
    }

    function applyBulkKoma(input) {
      const value = input.value;
      if (value === '') return;
      const tr = input.closest('tr');
      const gradeInputs = tr.querySelectorAll('.grade-koma');
      gradeInputs.forEach(function(gi) {
        gi.value = value;
      });
    }

    function removePlanRow(button) {
      const tr = button.closest('tr');
      const tbody = tr.parentElement;
      if (tbody.children.length <= 1) {
        setStatus('最低1行の計画が必要です。');
        return;
      }
      tr.remove();
    }

    function renderPlanRows(rows) {
      const tbody = document.getElementById('planBody');
      tbody.innerHTML = '';
      normalizePlanRows(rows).forEach(function(row) {
        appendPlanRow(row);
      });
    }

    function addPlanRow() {
      const rows = document.querySelectorAll('#planBody tr');
      let maxOrder = 0;
      rows.forEach(function(row) {
        const value = Number(row.querySelector('.cycle-order').value);
        if (value > maxOrder) {
          maxOrder = value;
        }
      });

      appendPlanRow({
        cycleOrder: maxOrder + 1,
        startMonth: 4,
        endMonth: 5,
        g1Koma: 7,
        g2Koma: 7,
        g3Koma: 7,
        g4Koma: 7,
        g5Koma: 7,
        g6Koma: 7,
        note: ''
      });
    }

    function collectPlanRows() {
      const rows = [];
      const trs = document.querySelectorAll('#planBody tr');

      trs.forEach(function(tr) {
        const values = {
          cycleOrder: Number(tr.querySelector('.cycle-order').value),
          startMonth: Number(tr.querySelector('.start-month').value),
          endMonth: Number(tr.querySelector('.end-month').value),
          g1Koma: Number(tr.querySelector('.grade-koma[data-grade="1"]').value),
          g2Koma: Number(tr.querySelector('.grade-koma[data-grade="2"]').value),
          g3Koma: Number(tr.querySelector('.grade-koma[data-grade="3"]').value),
          g4Koma: Number(tr.querySelector('.grade-koma[data-grade="4"]').value),
          g5Koma: Number(tr.querySelector('.grade-koma[data-grade="5"]').value),
          g6Koma: Number(tr.querySelector('.grade-koma[data-grade="6"]').value),
          note: tr.querySelector('.note-input').value || ''
        };

        if (!Number.isFinite(values.cycleOrder) || values.cycleOrder <= 0) {
          throw new Error('クール順を正しく入力してください。');
        }

        rows.push(values);
      });

      if (rows.length === 0) {
        throw new Error('計画行がありません。');
      }

      return rows;
    }

    // ========================================
    // 曜日優先度設定
    // ========================================

    function renderWeekdayList() {
      const list = document.getElementById('weekdayList');
      list.innerHTML = '';

      currentWeekdayOrder.forEach(function(day, index) {
        const li = document.createElement('li');
        li.className = 'weekday-item';
        li.setAttribute('data-day', day);
        li.innerHTML = '<span class="weekday-order">' + (index + 1) + '</span>' +
          '<label style="flex:1;cursor:pointer"><input type="checkbox" checked onchange="toggleWeekday(' + day + ', this.checked)"> ' + escapeHtml(WEEKDAY_NAMES[day]) + '</label>' +
          '<span class="weekday-arrows">' +
            '<button type="button" onclick="moveWeekday(' + day + ',-1)" title="上へ"' + (index === 0 ? ' disabled' : '') + '>&#9650;</button>' +
            '<button type="button" onclick="moveWeekday(' + day + ',1)" title="下へ"' + (index === currentWeekdayOrder.length - 1 ? ' disabled' : '') + '>&#9660;</button>' +
          '</span>';
        list.appendChild(li);
      });

      [1, 2, 3, 4, 5].forEach(function(day) {
        if (currentWeekdayOrder.indexOf(day) === -1) {
          const li = document.createElement('li');
          li.className = 'weekday-item excluded';
          li.innerHTML = '<span class="weekday-order">-</span>' +
            '<label style="flex:1;cursor:pointer"><input type="checkbox" onchange="toggleWeekday(' + day + ', this.checked)"> ' + escapeHtml(WEEKDAY_NAMES[day]) + '</label>' +
            '<span class="weekday-arrows"></span>';
          list.appendChild(li);
        }
      });
    }

    function moveWeekday(day, direction) {
      const index = currentWeekdayOrder.indexOf(day);
      if (index < 0) return;
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= currentWeekdayOrder.length) return;
      currentWeekdayOrder.splice(index, 1);
      currentWeekdayOrder.splice(newIndex, 0, day);
      renderWeekdayList();
    }

    function toggleWeekday(day, enabled) {
      if (enabled) {
        if (currentWeekdayOrder.indexOf(day) === -1) {
          currentWeekdayOrder.push(day);
        }
      } else {
        const index = currentWeekdayOrder.indexOf(day);
        if (index >= 0) {
          currentWeekdayOrder.splice(index, 1);
        }
      }
      renderWeekdayList();
    }

    function resetWeekdayOrder() {
      currentWeekdayOrder = DEFAULT_WEEKDAY_ORDER.slice();
      renderWeekdayList();
    }

    function saveWeekdayPriority() {
      if (currentWeekdayOrder.length === 0) {
        setStatus('少なくとも1つの曜日を有効にしてください。');
        return;
      }
      setLoading(true);
      setStatus('曜日設定を保存して再集計中...');
      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '曜日設定を保存しました。');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('曜日設定の保存に失敗しました: ' + getErrorMessage(error));
        })
        .saveWeekdayPriorityFromDialog({
          orderedDays: currentWeekdayOrder,
          baseDate: currentState.baseDate
        });
    }

    // ========================================
    // 実施差分
    // ========================================

    function renderRecentExceptions(rows) {
      const tbody = document.getElementById('recentExceptionBody');
      tbody.innerHTML = '';

      if (!Array.isArray(rows) || rows.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="6">実施差分はまだありません。</td>';
        tbody.appendChild(emptyRow);
        return;
      }

      rows.forEach(function(row) {
        const tr = document.createElement('tr');
        tr.innerHTML = [
          '<td>' + escapeHtml(row.date) + '</td>',
          '<td>' + escapeHtml(row.grade) + '年</td>',
          '<td>' + escapeHtml(row.deltaDisplay) + '</td>',
          '<td>' + escapeHtml(row.reason || '') + '</td>',
          '<td>' + escapeHtml(row.note || '') + '</td>',
          '<td><button type="button" class="small-btn danger" onclick="deleteException(' + row.rowNumber + ')" title="削除">&times;</button></td>'
        ].join('');
        tbody.appendChild(tr);
      });
    }

    function deleteException(rowNumber) {
      if (!window.confirm('この実施差分を削除しますか？')) return;
      setLoading(true);
      setStatus('実施差分を削除中...');
      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '削除しました。');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('削除に失敗しました: ' + getErrorMessage(error));
        })
        .deleteModuleExceptionFromDialog({
          rowNumber: rowNumber,
          baseDate: currentState.baseDate
        });
    }

    function populateGradeOptions() {
      const select = document.getElementById('exceptionGrade');
      if (select.options.length > 0) {
        return;
      }
      for (let grade = 1; grade <= 6; grade++) {
        const option = document.createElement('option');
        option.value = String(grade);
        option.textContent = grade + '年';
        select.appendChild(option);
      }
    }

    function setDelta(value) {
      document.getElementById('deltaSessionsInput').value = String(value);
      updateDeltaHint();
    }

    function formatMixedFractionFromSessions(sessions) {
      const rounded = Math.round(Number(sessions) || 0);
      if (rounded === 0) {
        return '0';
      }
      const sign = rounded < 0 ? '-' : '';
      const absValue = Math.abs(rounded);
      const whole = Math.floor(absValue / 3);
      const remainder = absValue % 3;
      if (remainder === 0) {
        return sign + String(whole);
      }
      if (whole === 0) {
        return sign + String(remainder) + '/3';
      }
      return sign + String(whole) + ' ' + String(remainder) + '/3';
    }

    function updateDeltaHint() {
      const sessions = Math.round(Number(document.getElementById('deltaSessionsInput').value) || 0);
      const prefix = sessions > 0 ? '+' : '';
      const minutes = sessions * 15;
      const minutePrefix = minutes > 0 ? '+' : '';
      document.getElementById('deltaHint').textContent = '現在の差分: ' + prefix + formatMixedFractionFromSessions(sessions) + 'コマ（' + minutePrefix + String(minutes) + '分）';
    }

    function addException() {
      const payload = {
        date: document.getElementById('exceptionDate').value,
        grade: Number(document.getElementById('exceptionGrade').value),
        deltaSessions: Number(document.getElementById('deltaSessionsInput').value),
        reason: document.getElementById('exceptionReason').value,
        note: document.getElementById('exceptionNote').value,
        baseDate: currentState.baseDate
      };

      if (!payload.date) {
        setStatus('日付を入力してください。');
        return;
      }
      if (!payload.deltaSessions) {
        setStatus('差分値は0以外で入力してください。');
        return;
      }

      setLoading(true);
      setStatus('実施差分を保存して再集計しています...');

      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '実施差分を追加しました。');
          document.getElementById('exceptionReason').value = '';
          document.getElementById('exceptionNote').value = '';
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('実施差分の保存に失敗しました: ' + getErrorMessage(error));
        })
        .addModuleExceptionFromDialog(payload);
    }

    // ========================================
    // プレビュー
    // ========================================

    function previewPlan() {
      const fiscalYear = Number(document.getElementById('fiscalYearInput').value);
      let planRows;

      try {
        planRows = collectPlanRows();
      } catch (error) {
        setStatus(getErrorMessage(error));
        return;
      }

      setLoading(true);
      setStatus('プレビューを生成中...');

      google.script.run
        .withSuccessHandler(function(result) {
          setLoading(false);
          setStatus('');
          showPreview(result);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('プレビュー生成に失敗しました: ' + getErrorMessage(error));
        })
        .previewModulePlan({
          fiscalYear: fiscalYear,
          baseDate: currentState.baseDate,
          plans: planRows
        });
    }

    function showPreview(result) {
      const area = document.getElementById('previewArea');
      area.classList.add('visible');

      let html = '<strong>配分プレビュー</strong>（日次計画: ' + result.totalDailyPlanCount + '件）';

      // 学年別合計テーブル
      html += '<table class="preview-table"><thead><tr><th>学年</th><th>計画(コマ)</th><th>経過(コマ)</th><th>今週(コマ)</th></tr></thead><tbody>';
      for (let grade = 1; grade <= 6; grade++) {
        const t = result.totalsByGrade[grade] || {};
        html += '<tr><td>' + grade + '年</td>' +
          '<td>' + formatMixedFractionFromSessions(t.plannedSessions || 0) + '</td>' +
          '<td>' + formatMixedFractionFromSessions(t.elapsedSessions || 0) + '</td>' +
          '<td>' + formatMixedFractionFromSessions(t.thisWeekSessions || 0) + '</td></tr>';
      }
      html += '</tbody></table>';

      // クール別配分テーブル
      if (result.cycleSummaries && result.cycleSummaries.length > 0) {
        html += '<div style="margin-top:8px"><strong>クール別配分日数</strong></div>';
        html += '<table class="preview-table"><thead><tr><th>クール</th><th>期間</th>';
        for (let g = 1; g <= 6; g++) {
          html += '<th>' + g + '年</th>';
        }
        html += '</tr></thead><tbody>';

        let hasNoSchoolDayCycle = false;
        result.cycleSummaries.forEach(function(cycle) {
          const allZeroSchoolDays = cycle.schoolDays && Object.keys(cycle.schoolDays).every(function(g) {
            return cycle.schoolDays[g] === 0;
          });
          if (allZeroSchoolDays) {
            hasNoSchoolDayCycle = true;
          }
          html += '<tr><td>' + cycle.cycleOrder + '</td><td>' + escapeHtml(cycle.label) + '</td>';
          for (let gr = 1; gr <= 6; gr++) {
            const days = (cycle.days && cycle.days[gr]) || 0;
            const schoolDays = (cycle.schoolDays && cycle.schoolDays[gr]) || 0;
            if (days === 0 && schoolDays === 0) {
              html += '<td style="color:#999">- (データなし)</td>';
            } else {
              html += '<td>' + days + '日</td>';
            }
          }
          html += '</tr>';
        });

        html += '</tbody></table>';
        if (hasNoSchoolDayCycle) {
          html += '<div style="margin-top:4px;color:#e65100;font-size:12px">' +
            '※ 年間行事予定表に該当月の学校日データがないクールは配分できません。' +
            '</div>';
        }

        let overflowDetails = [];
        if (result.overflowByGrade) {
          for (let gr = 1; gr <= 6; gr++) {
            if ((result.overflowByGrade[gr] || 0) > 0) {
              overflowDetails.push(gr + '年: ' + result.overflowByGrade[gr] + '回（' + (result.overflowByGrade[gr] * 15) + '分）');
            }
          }
        }
        if (overflowDetails.length > 0) {
          html += '<div style="margin-top:6px;padding:8px;background:#fff3e0;border:1px solid #ffcc80;border-radius:4px;font-size:12px;color:#e65100">' +
            '<strong>注意: 配分しきれないセッション</strong><br>' +
            '配分曜日数に対してセッション数が多く、最終クールまでに配分しきれないセッションがあります。<br>' +
            overflowDetails.join('、') + '<br>' +
            '<span style="font-size:11px;color:#bf360c">→ コマ数を減らすか、配分曜日設定で曜日を追加すると解消できます。</span>' +
            '</div>';
        }
      }

      area.innerHTML = html;
    }

    // ========================================
    // 状態管理
    // ========================================

    function applyState(state) {
      currentState = state || {};
      updateSummary(currentState);
      renderPlanRows(currentState.cyclePlans || []);
      renderRecentExceptions(currentState.recentExceptions || []);

      document.getElementById('exceptionDate').value = currentState.baseDate || '';
      populateGradeOptions();
      updateDeltaHint();

      if (Array.isArray(currentState.weekdayPriority) && currentState.weekdayPriority.length > 0) {
        currentWeekdayOrder = currentState.weekdayPriority.slice();
      }
      renderWeekdayList();
    }

    function loadDialogState(keepStatus) {
      if (!keepStatus) {
        setStatus('現在の状態を読み込み中...');
      }

      google.script.run
        .withSuccessHandler(function(state) {
          applyState(state || {});
          if (!keepStatus) {
            setStatus('');
          }
        })
        .withFailureHandler(function(error) {
          setStatus('状態の取得に失敗しました: ' + getErrorMessage(error));
        })
        .getModulePlanningDialogState();
    }

    function savePlan() {
      const fiscalYear = Number(document.getElementById('fiscalYearInput').value);
      let planRows;

      try {
        planRows = collectPlanRows();
      } catch (error) {
        setStatus(getErrorMessage(error));
        return;
      }

      setLoading(true);
      setStatus('計画を保存して再集計しています...');

      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '計画を保存しました。');
          document.getElementById('previewArea').classList.remove('visible');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('計画保存に失敗しました: ' + getErrorMessage(error));
        })
        .saveModuleCyclePlanFromDialog({
          fiscalYear: fiscalYear,
          baseDate: currentState.baseDate,
          plans: planRows
        });
    }

    function refreshPlanning() {
      setLoading(true);
      setStatus('再集計を実行中...');
      google.script.run
        .withSuccessHandler(function(message) {
          setLoading(false);
          setStatus(message || '再集計が完了しました。');
          loadDialogState(true);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          setStatus('再集計に失敗しました: ' + getErrorMessage(error));
        })
        .refreshModulePlanning();
    }

    window.onload = function() {
      loadDialogState(false);
      setDelta(3);
    };
  </script>
</body>
</html>
