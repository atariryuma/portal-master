<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼è¨­å®š</title>
  <?!= include_('dialogStyles') ?>
  <style>
    /* ãƒˆãƒªã‚¬ãƒ¼è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .trigger-section {
      background-color: #f5f5f5;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid var(--pm-border);
    }
    .trigger-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .trigger-header h3 {
      margin: 0;
      font-size: 16px;
      flex-grow: 1;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--pm-success);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>âš™ï¸ è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼è¨­å®š</h2>

    <div class="info-box">
      â„¹ï¸ <strong>è‡ªå‹•å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’è¨­å®šã§ãã¾ã™</strong><br>
      å„å‡¦ç†ã®æœ‰åŠ¹/ç„¡åŠ¹ã€å®Ÿè¡Œæ™‚åˆ»ã€å®Ÿè¡Œæ›œæ—¥ï¼ˆé€±æ¬¡å‡¦ç†ã®ã¿ï¼‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚
    </div>

    <div class="warning-box">
      âš ï¸ <strong>æ³¨æ„äº‹é …</strong><br>
      ãƒ»è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã¨æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã¯å…¨ã¦å‰Šé™¤ã•ã‚Œã€æ–°ã—ãä½œæˆã•ã‚Œã¾ã™<br>
      ãƒ»æ™‚åˆ»ã¯0ï½23æ™‚ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆæ·±å¤œãƒ»æ—©æœæ¨å¥¨ï¼‰<br>
      ãƒ»ãƒˆãƒªã‚¬ãƒ¼ã®å®Ÿè¡Œæ™‚åˆ»ã¯å‰å¾Œ1æ™‚é–“ç¨‹åº¦ãšã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
    </div>

    <!-- ãƒˆãƒªã‚¬ãƒ¼1: é€±å ±PDFä¿å­˜ -->
    <div class="trigger-section">
      <div class="trigger-header">
        <h3>ğŸ“„ é€±å ±ã‚’PDFä¿å­˜</h3>
        <label class="switch">
          <input type="checkbox" id="weeklyPdfEnabled" onchange="toggleTrigger('weeklyPdf')">
          <span class="slider"></span>
        </label>
      </div>
      <div id="weeklyPdfSettings">
        <div class="form-row">
          <div class="form-group">
            <label for="weeklyPdfDay">å®Ÿè¡Œæ›œæ—¥</label>
            <select id="weeklyPdfDay">
              <option value="0">æ—¥æ›œæ—¥</option>
              <option value="1" selected>æœˆæ›œæ—¥</option>
              <option value="2">ç«æ›œæ—¥</option>
              <option value="3">æ°´æ›œæ—¥</option>
              <option value="4">æœ¨æ›œæ—¥</option>
              <option value="5">é‡‘æ›œæ—¥</option>
              <option value="6">åœŸæ›œæ—¥</option>
            </select>
          </div>
          <div class="form-group">
            <label for="weeklyPdfHour">å®Ÿè¡Œæ™‚åˆ»ï¼ˆæ™‚ï¼‰</label>
            <input type="number" id="weeklyPdfHour" min="0" max="23" value="2">
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒˆãƒªã‚¬ãƒ¼2: ç´¯è¨ˆæ™‚æ•°è¨ˆç®— -->
    <div class="trigger-section">
      <div class="trigger-header">
        <h3>ğŸ§® ç´¯è¨ˆæ™‚æ•°ã‚’è¨ˆç®—</h3>
        <label class="switch">
          <input type="checkbox" id="cumulativeHoursEnabled" onchange="toggleTrigger('cumulativeHours')">
          <span class="slider"></span>
        </label>
      </div>
      <div id="cumulativeHoursSettings">
        <div class="form-row">
          <div class="form-group">
            <label for="cumulativeHoursDay">å®Ÿè¡Œæ›œæ—¥</label>
            <select id="cumulativeHoursDay">
              <option value="0">æ—¥æ›œæ—¥</option>
              <option value="1" selected>æœˆæ›œæ—¥</option>
              <option value="2">ç«æ›œæ—¥</option>
              <option value="3">æ°´æ›œæ—¥</option>
              <option value="4">æœ¨æ›œæ—¥</option>
              <option value="5">é‡‘æ›œæ—¥</option>
              <option value="6">åœŸæ›œæ—¥</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cumulativeHoursHour">å®Ÿè¡Œæ™‚åˆ»ï¼ˆæ™‚ï¼‰</label>
            <input type="number" id="cumulativeHoursHour" min="0" max="23" value="2">
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒˆãƒªã‚¬ãƒ¼3: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ -->
    <div class="trigger-section">
      <div class="trigger-header">
        <h3>ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒæœŸ</h3>
        <label class="switch">
          <input type="checkbox" id="calendarSyncEnabled" onchange="toggleTrigger('calendarSync')">
          <span class="slider"></span>
        </label>
      </div>
      <div id="calendarSyncSettings">
        <div class="form-row">
          <div class="form-group">
            <label for="calendarSyncHour">å®Ÿè¡Œæ™‚åˆ»ï¼ˆæ™‚ï¼‰</label>
            <input type="number" id="calendarSyncHour" min="0" max="23" value="3">
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒˆãƒªã‚¬ãƒ¼4: ä»Šæ—¥ã®æ—¥ä»˜ã¸ç§»å‹• -->
    <div class="trigger-section">
      <div class="trigger-header">
        <h3>ğŸ”— ä»Šæ—¥ã®æ—¥ä»˜ã¸ç§»å‹•</h3>
        <label class="switch">
          <input type="checkbox" id="dailyLinkEnabled" onchange="toggleTrigger('dailyLink')">
          <span class="slider"></span>
        </label>
      </div>
      <div id="dailyLinkSettings">
        <div class="form-row">
          <div class="form-group">
            <label for="dailyLinkHour">å®Ÿè¡Œæ™‚åˆ»ï¼ˆæ™‚ï¼‰</label>
            <input type="number" id="dailyLinkHour" min="0" max="23" value="4">
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ -->
    <div class="button-group">
      <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜ã—ã¦è¨­å®š</button>
      <button class="btn btn-secondary" onclick="google.script.host.close()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <script>
    // åˆæœŸåŒ–: æ—¢å­˜ã®è¨­å®šå€¤ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    window.onload = function() {
      google.script.run
        .withSuccessHandler(loadSettings)
        .withFailureHandler(handleError)
        .getTriggerSettings();
    };

    // è¨­å®šå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    function loadSettings(settings) {
      // é€±å ±PDFä¿å­˜
      document.getElementById('weeklyPdfEnabled').checked = settings.weeklyPdf.enabled;
      document.getElementById('weeklyPdfDay').value = settings.weeklyPdf.day;
      document.getElementById('weeklyPdfHour').value = settings.weeklyPdf.hour;
      toggleTrigger('weeklyPdf');

      // ç´¯è¨ˆæ™‚æ•°è¨ˆç®—
      document.getElementById('cumulativeHoursEnabled').checked = settings.cumulativeHours.enabled;
      document.getElementById('cumulativeHoursDay').value = settings.cumulativeHours.day;
      document.getElementById('cumulativeHoursHour').value = settings.cumulativeHours.hour;
      toggleTrigger('cumulativeHours');

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ
      document.getElementById('calendarSyncEnabled').checked = settings.calendarSync.enabled;
      document.getElementById('calendarSyncHour').value = settings.calendarSync.hour;
      toggleTrigger('calendarSync');

      // ä»Šæ—¥ã®æ—¥ä»˜ã¸ç§»å‹•
      document.getElementById('dailyLinkEnabled').checked = settings.dailyLink.enabled;
      document.getElementById('dailyLinkHour').value = settings.dailyLink.hour;
      toggleTrigger('dailyLink');
    }

    // ãƒˆãƒªã‚¬ãƒ¼ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
    function toggleTrigger(triggerName) {
      const enabled = document.getElementById(triggerName + 'Enabled').checked;
      const settings = document.getElementById(triggerName + 'Settings');

      if (enabled) {
        settings.classList.remove('disabled');
      } else {
        settings.classList.add('disabled');
      }
    }

    // è¨­å®šå€¤ã‚’ä¿å­˜
    function saveSettings() {
      // å…¥åŠ›å€¤ã®æ¤œè¨¼
      const settings = {
        weeklyPdf: {
          enabled: document.getElementById('weeklyPdfEnabled').checked,
          day: parseInt(document.getElementById('weeklyPdfDay').value, 10),
          hour: parseInt(document.getElementById('weeklyPdfHour').value, 10)
        },
        cumulativeHours: {
          enabled: document.getElementById('cumulativeHoursEnabled').checked,
          day: parseInt(document.getElementById('cumulativeHoursDay').value, 10),
          hour: parseInt(document.getElementById('cumulativeHoursHour').value, 10)
        },
        calendarSync: {
          enabled: document.getElementById('calendarSyncEnabled').checked,
          hour: parseInt(document.getElementById('calendarSyncHour').value, 10)
        },
        dailyLink: {
          enabled: document.getElementById('dailyLinkEnabled').checked,
          hour: parseInt(document.getElementById('dailyLinkHour').value, 10)
        }
      };

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!validateSettings(settings)) {
        return;
      }

      // ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
      google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleError)
        .saveTriggerSettings(settings);
    }

    // å…¥åŠ›å€¤ã®æ¤œè¨¼
    function validateSettings(settings) {
      const hours = [
        settings.weeklyPdf.hour,
        settings.cumulativeHours.hour,
        settings.calendarSync.hour,
        settings.dailyLink.hour
      ];

      let isValid = true;
      hours.forEach(function(hour) {
        if (hour < 0 || hour > 23 || isNaN(hour)) {
          alert('âš ï¸ æ™‚åˆ»ã¯0ï½23ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
          isValid = false;
        }
      });

      return isValid;
    }

    // ä¿å­˜æˆåŠŸæ™‚ã®å‡¦ç†
    function handleSuccess(message) {
      alert('âœ… ' + message);
      google.script.host.close();
    }

    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
    function handleError(error) {
      alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + error.message);
    }
  </script>
</body>
</html>
