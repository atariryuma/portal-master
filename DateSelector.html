<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include_('dialogStyles') ?>
  <style>
    /* 日付選択ダイアログ固有スタイル */
    form {
      max-width: 380px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--pm-surface);
      box-shadow: var(--pm-shadow);
      border-radius: var(--pm-radius);
    }
    label {
      margin: 10px 0 5px;
    }
    input[type="date"],
    input[type="number"] {
      margin-bottom: 15px;
      background-color: #fafafa;
      transition: border-color 0.2s;
    }
    input[type="date"]:focus,
    input[type="number"]:focus {
      border-color: #888;
      outline: none;
    }
    input[type="button"] {
      width: 100%;
      padding: 10px;
      background-color: var(--pm-primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    input[type="button"]:hover {
      background-color: var(--pm-primary-hover);
    }
    .section-title {
      font-weight: bold;
      margin-top: 20px;
      color: var(--pm-text);
      font-size: 1.2em;
      text-align: center;
    }
    .submit-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 20px;
      margin-top: 12px;
      color: #2f4f7f;
      font-size: 0.95em;
      visibility: hidden;
    }
    .submit-status.is-visible {
      visibility: visible;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #c8d8ef;
      border-top: 2px solid var(--pm-primary-hover);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  <script>
    function setSubmitting(isSubmitting, message) {
      const submitButton = document.getElementById('submitButton');
      const status = document.getElementById('submitStatus');
      const msg = document.getElementById('submitMessage');
      const form = document.getElementById('aggregateForm');
      submitButton.disabled = isSubmitting;
      if (form) {
        form.setAttribute('aria-busy', isSubmitting ? 'true' : 'false');
      }
      if (isSubmitting) {
        msg.textContent = message || '集計中...';
        status.classList.add('is-visible');
        status.setAttribute('aria-hidden', 'false');
      } else {
        status.classList.remove('is-visible');
        status.setAttribute('aria-hidden', 'true');
      }
    }

    function setDefaultStartDate() {
      const today = new Date();
      const year = today.getMonth() < 3 ? today.getFullYear() - 1 : today.getFullYear();
      const defaultStartDate = new Date(year, 3, 1); // 4月1日

      // ローカル日付コンポーネントから直接フォーマット（タイムゾーン非依存）
      const yyyy = String(defaultStartDate.getFullYear());
      const mm = String(defaultStartDate.getMonth() + 1).padStart(2, '0');
      const dd = String(defaultStartDate.getDate()).padStart(2, '0');
      document.getElementById('startDate').value = yyyy + '-' + mm + '-' + dd;
    }

    function submitForm() {
      const form = document.getElementById('aggregateForm');
      if (form && typeof form.reportValidity === 'function' && !form.reportValidity()) {
        return;
      }

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        window.alert('開始日と終了日を入力してください。');
        return;
      }

      setSubmitting(true, '集計中です。完了までお待ちください...');

      const gradeHours = {
        1: document.getElementById('grade1').value,
        2: document.getElementById('grade2').value,
        3: document.getElementById('grade3').value,
        4: document.getElementById('grade4').value,
        5: document.getElementById('grade5').value,
        6: document.getElementById('grade6').value
      };

      google.script.run
        .withSuccessHandler(function() {
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          setSubmitting(false);
          const message = (error && error.message) ? error.message : String(error || '不明なエラー');
          window.alert('集計に失敗しました: ' + message);
        })
        .processAggregateSchoolEventsByGrade(startDate, endDate, gradeHours);
    }

    function adjustDialogSize() {
      google.script.host.setHeight(document.body.scrollHeight + 20); // 余白分を追加
      google.script.host.setWidth(document.body.scrollWidth + 20);  // 余白分を追加
    }

    window.onload = function() {
      setDefaultStartDate();
      adjustDialogSize();
    };
  </script>
</head>
<body>
  <form id="aggregateForm">
    <label for="startDate">開始日:</label>
    <input type="date" id="startDate" required>
    <label for="endDate">終了日:</label>
    <input type="date" id="endDate" required>

    <div class="section-title">標準授業時数</div>

    <label for="grade1">1年:</label>
    <input type="number" id="grade1" value="850" required>
    <label for="grade2">2年:</label>
    <input type="number" id="grade2" value="910" required>
    <label for="grade3">3年:</label>
    <input type="number" id="grade3" value="980" required>
    <label for="grade4">4年:</label>
    <input type="number" id="grade4" value="1015" required>
    <label for="grade5">5年:</label>
    <input type="number" id="grade5" value="1015" required>
    <label for="grade6">6年:</label>
    <input type="number" id="grade6" value="1015" required>

    <input type="button" id="submitButton" value="送信" onclick="submitForm()">
    <div id="submitStatus" class="submit-status" aria-live="polite" aria-hidden="true">
      <span class="spinner" aria-hidden="true"></span>
      <span id="submitMessage">集計中...</span>
    </div>
  </form>
</body>
</html>
